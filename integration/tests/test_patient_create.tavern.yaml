test_name: Register a new user

stages:
  - name: register patient
    request:
      url: "{tavern.env_vars.service:s}/api/user/patient/"
      method: POST
      json:
        $ext:
          function: utils:fake_patient_create_body
    response:
      status_code: 201
      body:
        user:
          id: !anyint
      save:
        body:
          user_id: user.id
        $ext:
          function: utils:test_scope
          extra_kwargs:
            password: 'test1234'
            response_type: 'patient'

  - name: successful login
    request:
      url: "{tavern.env_vars.service:s}/api/authenticate/login"
      method: POST
      json:
        username: "{moca.patient.user.email}"
        email: "{moca.patient.user.email}"
        password: "{moca.kwargs.password}"
    response:
      status_code: 200
      body:
        token: !anystr

  - name: failed login
    request:
      url: "{tavern.env_vars.service:s}/api/authenticate/login"
      method: POST
      json:
        username: "{moca.patient.user.email}"
        email: "{moca.patient.user.email}"
        password: "{moca.patient.user.email}"
    response:
      status_code: 400
      body:
        nonFieldErrors:
          - "Incorrect Credentials"